/* eslint-disable */
module.exports = {
name: "@yarnpkg/plugin-build",
factory: function (require) {
var plugin;plugin=(()=>{"use strict";var e={446:(e,t,i)=>{i.r(t),i.d(t,{default:()=>A});const n=require("@yarnpkg/cli"),r=require("@yarnpkg/core"),o=require("@yarnpkg/libzip"),s=require("@yarnpkg/fslib"),a=require("clipanion"),u=require("path");var l=i.n(u),d=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};class c extends n.BaseCommand{constructor(){super(...arguments),this.json=!1,this.archiveName="bundle.tgz",this.exclude=[]}async removeUnusedPackages(e,t,i){const{project:o,workspace:a}=await r.Project.find(i,t);if(!a)throw new n.WorkspaceRequiredError(o.cwd,t);const u=new Set([a]);for(const e of u)for(const t of r.Manifest.hardDependencies)for(const i of e.manifest.getForScope(t).values()){const e=o.tryWorkspaceByDescriptor(i);null!==e&&u.add(e)}for(const t of o.workspaces)u.has(t)||t.cwd!==e&&await s.xfs.removePromise(t.cwd)}async removeExcluded(e,t){const i=e+"/.git";await s.xfs.lstatPromise(i)&&await s.xfs.removePromise(i),await t.map(async t=>{t.startsWith(e)&&await s.xfs.lstatPromise(t)&&await s.xfs.removePromise(t)})}async execute(){return await s.xfs.mktempPromise(async e=>{var t,i,a,u;const d=""+this.context.cwd,c=s.ppath.join(d,this.archiveName),p=await r.Configuration.find(this.context.cwd,this.context.plugins);if(null===p.projectCwd)throw new Error("Can't find project directory");const f=d.replace(p.projectCwd,""),v=new s.NodeFS;await s.xfs.copyPromise(e,p.projectCwd,{baseFs:v});const m=`${e}${f}`,g=this.exclude,b=`${m}/${this.archiveName}`;try{await s.xfs.lstatPromise(b)&&g.push(b)}catch(e){}await this.removeExcluded(e,g);const y=await r.Configuration.find(m,this.context.plugins),w=await r.Cache.find(y);await this.removeUnusedPackages(e,m,y);const{project:C,workspace:_}=await r.Project.find(y,m);if(!_)throw new n.WorkspaceRequiredError(C.cwd,m);const I=new Set([_]);for(const e of I)for(const t of r.Manifest.hardDependencies)for(const i of e.manifest.getForScope(t).values()){const e=C.tryWorkspaceByDescriptor(i);null!==e&&I.add(e)}for(const e of C.workspaces)e.manifest.devDependencies.clear(),I.has(e)||(e.manifest.dependencies.clear(),e.manifest.peerDependencies.clear());if(null===(i=null===(t=null==_?void 0:_.manifest)||void 0===t?void 0:t.raw)||void 0===i?void 0:i.main){const t=_.relativeCwd+l().sep+(null===(u=null===(a=null==_?void 0:_.manifest)||void 0===a?void 0:a.raw)||void 0===u?void 0:u.main),i="./.pnp.js";s.xfs.writeFilePromise(`${e}${l().sep}entrypoint.js`,h(t,i))}return(await r.StreamReport.start({configuration:y,json:this.json,stdout:this.context.stdout,includeLogs:!0},async t=>{await C.install({cache:w,report:t}),t.reportInfo(null,"Getting libzip");const i=await(0,o.getLibzipPromise)();t.reportInfo(null,"Creating archive");const n=new s.ZipFS(c,{create:!0,libzip:i});t.reportInfo(null,"Copying files to archive"),await n.copyPromise("bundle",e,{baseFs:v}),n.saveAndClose(),t.reportJson({name:"ArchiveSuccess",message:"Archive created successfuly at ",outputArchive:c})})).exitCode()})}}c.usage=a.Command.Usage({category:"Build commands",description:"bundle a workspace package into a deployable archive",details:"\n      This command will bundle up the source of the target package along with\n      its dependencies into an archive.\n\n      This is designed to be used for deployment, not for publishing, so\n      everything to run except for a runtime (ie node) is bundled into\n      the archive.\n\n      Call this after you have run your build step (if any).\n\n      This is designed to work best with zero-install configurations. If you\n      don't have that, run `yarn install` before this command.\n\n      Why not just compile like we do on the front-end?\n      Some dependencies may use require in interesting ways, or be or call\n      binaries. It's safest not to transpile them.\n\n      If the `--json` flag is set the output will follow a JSON-stream output\n      also known as NDJSON (https://github.com/ndjson/ndjson-spec).\n\n      `-o,--output-directory` sets the output directory.\n\n      `-a,--archive-name` sets the name of the archive. Any files matching\n      this, will be excluded from subsequent archives. Defaults to ./bundle.tgz\n    "}),d([a.Command.Boolean("--json")],c.prototype,"json",void 0),d([a.Command.String("-o,--output-directory")],c.prototype,"outputDirectory",void 0),d([a.Command.String("-a,--archive-name")],c.prototype,"archiveName",void 0),d([a.Command.Array("--exclude")],c.prototype,"exclude",void 0),d([a.Command.Path("bundle")],c.prototype,"execute",null);const h=(e,t)=>`\n"use strict";\n\nconst pnp = require("${t}").setup();\n\nconst index = require("./${e}");\n\nObject.defineProperty(exports, "__esModule", { value: true });\n\nexports.default = index;\n`,p=require("@yarnpkg/parsers");async function f(){const e=await r.Configuration.find(s.ppath.cwd(),null);return await async function(e){var t,i,n,r,o,a,u;let l={};const d=s.ppath.join(e.projectCwd||e.startingCwd,".yarnbuildrc.yml");if(s.xfs.existsSync(d)){const e=await s.xfs.readFilePromise(d,"utf8");try{l=(0,p.parseSyml)(e)}catch(t){let i="";throw e.match(/^\s+(?!-)[^:]+\s+\S+/m)&&(i=" (in particular, make sure you list the colons after each key name)"),new Error(`Parse error when loading ${d}; please check it's proper Yaml${i}`)}}return{commands:{build:"string"==typeof(null===(t=null==l?void 0:l.commands)||void 0===t?void 0:t.build)?l.commands.build:"build",test:"string"==typeof(null===(i=null==l?void 0:l.commands)||void 0===i?void 0:i.test)?l.commands.test:"test",dev:"string"==typeof(null===(n=null==l?void 0:l.commands)||void 0===n?void 0:n.dev)?l.commands.dev:"dev"},folders:{input:"string"==typeof(null===(r=null==l?void 0:l.folders)||void 0===r?void 0:r.input)?l.folders.input:"src",output:"string"==typeof(null===(o=null==l?void 0:l.folders)||void 0===o?void 0:o.output)?l.folders.output:"build"},enableBetaFeatures:{folderConfiguration:"string"!=typeof(null===(a=null==l?void 0:l.enableBetaFeatures)||void 0===a?void 0:a.folderConfiguration)||"false"!==(null===(u=null==l?void 0:l.enableBetaFeatures)||void 0===u?void 0:u.folderConfiguration)}}}(e)}var v=i(820),m=i.n(v);const g=require("os"),b=require("events");var y=i(103),w=i(299),C=i.n(w),_=i(344),I=i(106),R=i.n(I);const E=require("readline");var P,S,T=i.n(E);class x{constructor(){this.nodes={},this.size=0,this.buildSize=0,this.built=new Set}addNode(e){if(this.nodes[e])return this.nodes[e];const t=new B(e,this);return this.nodes[e]=t,this.size++,t}getNode(e){if(this.nodes[e])return this.nodes[e]}resetBuilds(){this.built=new Set}async resolve(e){const t=new Set,i=new Set;await this.resolveNode(e,t,i)}async resolveNode(e,t,i){i.add(e.id);for(const n of e.dependencies)if(!t.has(n.id)){if(i.has(n.id))throw new $(`${e.id} has a cyclic dependency on ${n.id}`);await this.resolveNode(n,t,i)}t.add(e.id),i.delete(e.id)}async build(e){const t=new Set,i=new Set,n={};for(const i of e)this.resolveQueue(i,t,n);return await new Promise(e=>{this.workLoop(t,n,i,e)}),n}workLoop(e,t,i,n){0!==e.size&&e.forEach(n=>{var r,o;n.canStart(t)&&((null===(r=null==n?void 0:n.node)||void 0===r?void 0:r.buildCallback)?(null===(o=null==n?void 0:n.node)||void 0===o||o.buildCallback(t),i.add(n.node)):t[n.node.id]={success:!0,done:!0},e.delete(n))}),i.forEach((e,n)=>{t[e.id].done&&i.delete(n)}),Object.keys(t).map(e=>{var i,n;return null===(n=null===(i=t[e])||void 0===i?void 0:i.done)||void 0===n||n}).every(e=>!0===e)?n():setTimeout(()=>this.workLoop(e,t,i,n),30)}resolveQueue(e,t,i){const n=[];for(const r of e.dependencies)if(n.push(r.id),!i[r.id]&&r.buildCallback){i[r.id]=Object.assign({},x.BuildLogInit);const e=this.resolveQueue(r,t,i),n={node:r,canStart:x.QueueItemCanStart(e)};t.add(n)}if(!i[e.id]&&e.buildCallback){i[e.id]=Object.assign({},x.BuildLogInit);const r={node:e,canStart:x.QueueItemCanStart(n)};t.add(r)}return n}}x.BuildLogInit={success:!1,done:!1},x.QueueItemCanStart=e=>t=>e.map(e=>{var i,n;return null===(n=null===(i=t[e])||void 0===i?void 0:i.done)||void 0===n||n}).every(e=>!0===e);class B{constructor(e,t){this.id=e,this.dependencies=[],this.graph=t}addDependency(e){return this.dependencies.push(e),this}addWorkSpace(e){return this.workspace=e,this}addBuildCallback(e){return this.buildCallback||(this.buildCallback=t=>e().then(e=>{t[this.id]={done:!0,success:e}}),this.graph.buildSize++),this}}class $ extends Error{constructor(e){super(e),this.name="CyclicDependencyError",this.code="YN0003"}}!function(e){e.pending="pending",e.inProgress="inProgress",e.failed="failed",e.succeeded="succeeded"}(P||(P={})),function(e){e.pending="pending",e.start="start",e.info="info",e.error="error",e.success="success",e.fail="fail",e.finish="finish"}(S||(S={}));const k=async(e,t)=>{let i=0;const n=await s.xfs.readdirPromise(e);return await Promise.all(n.map(async n=>{const r=`${e}${l().sep}${n}`;if(t&&r.startsWith(t))return;const o=await s.xfs.statPromise(r);if(o.isFile&&o.mtimeMs>i&&(i=o.mtimeMs),o.isDirectory()){const e=await k(r,t);e>i&&(i=e)}})),i},L=(e,t)=>{const i=Math.abs(t-e);let n="";const r=i/1e3/60;return r>1&&(n+=r+"m "),n+=(i/1e3).toFixed(2)+"s",n};const O=class{constructor({project:e,report:t,buildCommand:i,cli:n,configuration:o,pluginConfiguration:a,dryRun:u,verbose:l}){this.buildGraph=new x,this.buildLength=0,this.buildTargets=[],this.buildMutexes={},this.dryRun=!1,this.verbose=!1,this.entrypoints=[],this.limit=C()(Math.max(1,(0,g.cpus)().length)),this.buildReporter=new b.EventEmitter,this.buildReport={mutex:new _.W,totalJobs:0,previousOutputNumLines:0,successCount:0,failCount:0,workspaces:{},done:!1},this.concurrency=Math.max(1,(0,g.cpus)().length),this.nextUnitOfWork=[],this.hasSetup=!1,this.setupBuildReporter=()=>{this.buildReporter.on(S.pending,(e,t)=>{this.buildReport.mutex.acquire().then(i=>{this.buildReport.workspaces[e]={name:t,stdout:[],stderr:[],done:!1,fail:!1},i()})}),this.buildReporter.on(S.start,(e,t,i)=>{this.buildReport.mutex.acquire().then(n=>{this.buildReport.workspaces[e]=Object.assign(Object.assign({},this.buildReport.workspaces[e]),{start:Date.now(),buildScript:i,name:t}),n()})}),this.buildReporter.on(S.info,(e,t)=>{this.buildReport.mutex.acquire().then(i=>{this.buildReport.workspaces[e].stdout.push(t),i()})}),this.buildReporter.on(S.error,(e,t)=>{this.buildReport.mutex.acquire().then(i=>{this.buildReport.workspaces[e].stderr.push(t),this.logError(`${e} ${t}`),i()})}),this.buildReporter.on(S.success,e=>{this.buildReport.mutex.acquire().then(t=>{this.buildReport.workspaces[e]=Object.assign(Object.assign({},this.buildReport.workspaces[e]),{done:!0}),this.buildReport.successCount++,t()})}),this.buildReporter.on(S.fail,(e,t)=>{this.buildReport.mutex.acquire().then(i=>{this.buildReport.workspaces[e].stderr.push(t),this.buildReport.workspaces[e].done=!0,this.buildReport.workspaces[e].fail=!0,this.buildReport.failCount++,this.logError(`${e} ${t}`),i()})})},this.plan=async e=>{var t,i,n,o,s;const a=this.buildGraph.addNode(e.relativeCwd).addWorkSpace(e);let u=!1;this.buildMutexes[e.relativeCwd]=new _.W;for(const t of r.Manifest.hardDependencies)for(const i of e.manifest.getForScope(t).values()){const e=this.project.tryWorkspaceByDescriptor(i);if(null===e)continue;const t=this.buildGraph.addNode(e.relativeCwd).addWorkSpace(e);a.addDependency(t);const n=await this.plan(e);let r=!1;e!==this.project.topLevelWorkspace&&(r=await this.checkIfBuildIsRequired(e)),(r||n)&&(u=!0,t.addBuildCallback(this.build(e)))}let l=!1;if(e!==this.project.topLevelWorkspace&&(l=await this.checkIfBuildIsRequired(e)),this.buildReporter.emit(S.pending,e.relativeCwd),u||l)return this.buildReporter.emit(S.pending,e.relativeCwd,`${(null===(t=e.manifest.name)||void 0===t?void 0:t.scope)?`@${null===(i=e.manifest.name)||void 0===i?void 0:i.scope}/`:""}${null===(n=e.manifest.name)||void 0===n?void 0:n.name}`),a.addBuildCallback(this.build(e)),!0;{const t=null===(o=this.buildLog)||void 0===o?void 0:o.get(e.relativeCwd);t&&(null===(s=this.buildLog)||void 0===s||s.set(e.relativeCwd,{lastModified:t.lastModified,status:P.succeeded,haveCheckedForRebuild:!0,rebuild:!1}))}return!1},this.run=async()=>{var e,t;if(!1===this.hasSetup)throw new Error("BuildSupervisor is not setup, you need to call await supervisor.setup()");if(this.buildReport.buildStart=Date.now(),this.dryRun||m()||this.raf(this.waitUntilDone),this.dryRun)return;this.currentBuildTarget=this.buildTargets.length>1?"All":null!==(t=null===(e=this.buildTargets[0])||void 0===e?void 0:e.relativeCwd)&&void 0!==t?t:"Nothing to build";const i=this.generateHeaderString();await this.buildGraph.build(this.entrypoints);const n=await this.buildReport.mutex.acquire();if(this.buildReport.done=!0,n(),m()||(T().moveCursor(process.stdout,0,-this.buildReport.previousOutputNumLines),T().clearScreenDown(process.stdout),process.stdout.cursorTo(0)),0!==this.buildReport.failCount){this.logError(i),process.stdout.write(i+"\n");for(const e in this.buildReport.workspaces){const t=this.buildReport.workspaces[e];if(0!==t.stdout.length){const i=`${this.configuration.format("➤","blueBright")} ${this.configuration.format("YN0009:","grey")} │ ┌ Errors for ${this.configuration.format(e,r.FormatType.PATH)}`;this.logError(i),process.stdout.write(i+"\n"),t.stdout.forEach(e=>{const t=e.split("\n");t.forEach((e,i)=>{if(0!==e.length){const n=`${this.configuration.format("➤","blueBright")} YN0009: │ ${t.length===i-1?"└":"│"} ${e}`;this.logError(n),process.stdout.write(n+"\n")}})});const n=`${this.configuration.format("➤","blueBright")} ${this.configuration.format("YN0009:","grey")} │ └ End ${this.configuration.format(e,r.FormatType.PATH)}`;this.logError(n),process.stdout.write(n+"\n")}if(0!==t.stderr.length){const i=`${this.configuration.format("➤","blueBright")} ${this.configuration.format("YN0009:","grey")} │ ┌ Errors ${this.configuration.format(e,r.FormatType.PATH)}`;this.logError(i),t.stderr.forEach(e=>{const t=(e instanceof Error?e.toString():""+e).split("\n");t.forEach((e,i)=>{if(0!==e.length){const n=`${this.configuration.format("➤","blueBright")} YN0009: │ ${t.length===i-1?"└":"│"} ${e}`;this.logError(n)}})});const n=`${this.configuration.format("➤","blueBright")} ${this.configuration.format("YN0009:","grey")} │ └ Errors ${this.configuration.format(e,r.FormatType.PATH)}`;this.logError(n)}}}const o=this.generateFinalReport();return process.stdout.write(o),this.logError(o),await this.saveBuildLog(),0===this.buildReport.failCount},this.raf=e=>{setImmediate(()=>e(Date.now()))},this.waitUntilDone=e=>{if(this.buildReport.done)return;T().moveCursor(process.stdout,0,-this.buildReport.previousOutputNumLines),T().clearScreenDown(process.stdout),process.stdout.cursorTo(0);const t=this.generateProgressString(e);var i;process.stdout.write(t),this.buildReport.previousOutputNumLines=(t.match(/\n/g)||[]).length,(i=70,new Promise(e=>setTimeout(e,i))).then(()=>{this.raf(this.waitUntilDone)})},this.generateBuildCountString=e=>{const t=e=>this.configuration.format(e,"grey"),i=this.configuration.format("➤","blueBright"),n=t("YN0000:");let r="";if(this.buildReport.buildStart){const o=this.configuration.format(""+this.buildReport.successCount,"green"),s=this.configuration.format(""+this.buildReport.failCount,"red"),a=this.configuration.format(""+this.buildGraph.buildSize,"grey");r+=`${i} ${n} └ ${t("[")}${o}${t(":")}${s}${t("/")}${a}${t("]")} ${L(this.buildReport.buildStart,e)}\n`}return r},this.generateFinalReport=()=>{const e=e=>this.configuration.format(e,"grey"),t=this.configuration.format("➤","blueBright"),i=e("YN0000:");let n=`${t} ${i} └ Build finished${0!=this.buildReport.failCount?this.configuration.format(` with ${this.buildReport.failCount} errors`,"red"):""}\n`;if(this.buildReport.buildStart){const r=this.configuration.format(""+this.buildReport.successCount,"green"),o=this.configuration.format(""+this.buildReport.failCount,"red"),s=this.configuration.format(""+this.buildGraph.buildSize,"grey");n+=`${t} ${i} ${e("[")}${r}${e(":")}${o}${e("/")}${s}${e("]")}\n`}return n},this.build=e=>async()=>await this.limit(async()=>{var t,i,n,r,o,s,a;const u=e.relativeCwd,l=e.manifest.scripts.get(this.buildCommand),d=null===(t=this.buildLog)||void 0===t?void 0:t.get(e.relativeCwd);if(this.buildReporter.emit(S.start,e.relativeCwd,`${(null===(i=e.manifest.name)||void 0===i?void 0:i.scope)?`@${null===(n=e.manifest.name)||void 0===n?void 0:n.scope}/`:""}${null===(r=e.manifest.name)||void 0===r?void 0:r.name}`,l),!l)return this.verbose&&this.buildReporter.emit(S.info,e.relativeCwd,`Missing \`${this.buildCommand}\` script in manifest.`),this.buildReporter.emit(S.success,e.relativeCwd),!0;try{if(0!==await this.cli(l,e.cwd,this.buildReporter,u))return this.buildReporter.emit(S.fail,e.relativeCwd),null===(o=this.buildLog)||void 0===o||o.set(e.relativeCwd,{lastModified:null==d?void 0:d.lastModified,status:P.failed,haveCheckedForRebuild:!0,rebuild:!1}),!1;null===(s=this.buildLog)||void 0===s||s.set(e.relativeCwd,{lastModified:null==d?void 0:d.lastModified,status:P.succeeded,haveCheckedForRebuild:!0,rebuild:!1}),this.buildReporter.emit(S.success,e.relativeCwd)}catch(t){return this.buildReporter.emit(S.fail,e.relativeCwd,t),null===(a=this.buildLog)||void 0===a||a.set(e.relativeCwd,{lastModified:null==d?void 0:d.lastModified,status:P.failed,haveCheckedForRebuild:!0,rebuild:!1}),!1}return!0}),this.configuration=o,this.pluginConfiguration=a,this.project=e,this.report=t,this.buildCommand=i,this.cli=n,this.dryRun=u,this.verbose=l,this.queue=new y.Z({concurrency:this.concurrency,carryoverConcurrencyCount:!0,timeout:5e4,throwOnTimeout:!0,autoStart:!0}),this.errorLogFile=s.xfs.createWriteStream(this.getBuildErrorPath(),{flags:"a"})}async setup(){this.buildLog=await this.readBuildLog(),this.setupBuildReporter(),this.hasSetup=!0}getBuildErrorPath(){return s.ppath.resolve(this.project.cwd,"build-error.log")}getBuildLogPath(){return s.ppath.resolve(this.project.cwd,".yarn","local-build-cache.json")}async readBuildLog(){const e=new Map;try{const t=await s.xfs.readJsonPromise(this.getBuildLogPath());if(t&&t.packages)for(const i in t.packages)e.set(i,{lastModified:t.packages[i].lastModified,status:t.packages[i].status,haveCheckedForRebuild:!1,rebuild:!0})}catch(e){}return e}async saveBuildLog(){if(!this.buildLog)return;const e={comment:"This is an auto-generated file, it keeps track of whats been built. This is a local file, don't store this in version control.",packages:{}};for(const[t,i]of this.buildLog)i.status===P.succeeded&&(e.packages[t]={lastModified:i.lastModified});await s.xfs.writeJsonPromise(this.getBuildLogPath(),e)}logError(e){this.errorLogFile.write("➤ YN0009: "+R()(e)+"\n")}async addBuildTarget(e){this.entrypoints.push(this.buildGraph.addNode(e.relativeCwd));await this.plan(e)&&this.buildTargets.push(e)}async checkIfBuildIsRequired(e){var t,i,n,r,o;let a=!1;const u=s.ppath.resolve(e.project.cwd,e.relativeCwd);let d,c;this.pluginConfiguration.enableBetaFeatures.folderConfiguration&&((null===(t=null==e?void 0:e.manifest)||void 0===t?void 0:t.raw["yarn.build"])&&"string"==typeof(null==e?void 0:e.manifest.raw["yarn.build"].output)?d=`${u}${l().sep}${null==e?void 0:e.manifest.raw["yarn.build"].output}`:this.pluginConfiguration.folders.output?d=`${u}${l().sep}${this.pluginConfiguration.folders.output}`:(null==e?void 0:e.manifest.raw.main)&&(d=`${u}${l().sep}${null==e?void 0:e.manifest.raw.main.substring(0,null==e?void 0:e.manifest.raw.main.lastIndexOf(l().sep))}`),(null===(i=null==e?void 0:e.manifest)||void 0===i?void 0:i.raw["yarn.build"])&&"string"==typeof(null==e?void 0:e.manifest.raw["yarn.build"].input)?c=`${u}${l().sep}${null==e?void 0:e.manifest.raw["yarn.build"].input}`:this.pluginConfiguration.folders.input&&(c=`${u}${l().sep}${this.pluginConfiguration.folders.input}`));const h=await this.buildReport.mutex.acquire();try{const t=null===(n=this.buildLog)||void 0===n?void 0:n.get(e.relativeCwd);if(null==t?void 0:t.haveCheckedForRebuild)return null===(r=null==t?void 0:t.rebuild)||void 0===r||r;const i=await k(null!=c?c:u,d);(null==t?void 0:t.lastModified)!==i&&(a=!0),null===(o=this.buildLog)||void 0===o||o.set(e.relativeCwd,{lastModified:i,status:a?P.succeeded:P.pending,haveCheckedForRebuild:!0,rebuild:a})}catch(t){this.logError(`${e.relativeCwd}: failed to get lastModified (${t})`)}finally{h()}return a}generateHeaderString(){return`${this.configuration.format("➤","blueBright")} ${this.configuration.format("YN0000:","grey")} ┌ ${this.configuration.format("Building","grey")} ${this.configuration.format(this.currentBuildTarget?this.currentBuildTarget:"",r.FormatType.SCOPE)}${this.dryRun?this.configuration.format(" --dry-run",r.FormatType.NAME):""}`}generateProgressString(e){const t=`${this.configuration.format("➤","blueBright")} ${this.configuration.format("YN0000:","grey")} │`;let i="";const n=e=>this.configuration.format(`[${e}]`,"grey"),o=e=>this.configuration.format(""+e,r.FormatType.NAME),s=this.configuration.format("IDLE","grey");i+=this.generateHeaderString()+"\n";let a=1;for(const s in this.buildReport.workspaces){const u=this.buildReport.workspaces[s];if(!u||!u.start||u.done)continue;const l=this.configuration.format(s,r.FormatType.PATH),d=this.configuration.format(`(${u.buildScript})`,r.FormatType.REFERENCE),c=u.start?this.configuration.format(L(u.start,e),r.FormatType.RANGE):"";i+=`${t} ${n(a++)} ${l}${o(u.name)} ${d} ${c}\n`}for(;a<this.concurrency+1;)i+=`${t} ${n(a++)} ${s}\n`;return this.buildReport.buildStart&&(i+=this.generateBuildCountString(e)),i}};var j=function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s};class N extends n.BaseCommand{constructor(){super(...arguments),this.json=!1,this.buildCommand="build",this.parallel=!0,this.interlaced=!1,this.verbose=!1,this.dryRun=!1,this.buildLog={}}async execute(){const e=await r.Configuration.find(this.context.cwd,this.context.plugins),t=await f();return(await r.StreamReport.start({configuration:e,json:this.json,stdout:this.context.stdout,includeLogs:!0},async i=>{const{project:n,workspace:o}=await r.Project.find(e,this.context.cwd),s=o||n.topLevelWorkspace,a=new O({project:n,configuration:e,pluginConfiguration:t,report:i,buildCommand:this.buildCommand,cli:async(e,t,i,n)=>{const o=new r.miscUtils.BufferStream;o.on("data",e=>null==i?void 0:i.emit(S.info,n,e&&e.toString()));const s=new r.miscUtils.BufferStream;s.on("data",e=>null==i?void 0:i.emit(S.error,n,e&&e.toString()));try{const i=await this.cli.run(["run",e],{cwd:t,stdout:o,stderr:s})||0;return o.end(),s.end(),i}catch(e){o.end(),s.end()}return 2},dryRun:this.dryRun,verbose:this.verbose});if(await a.setup(),0!==s.workspacesCwds.size){const e=D(s,n);for(const t of e){for(const e of r.Manifest.hardDependencies)for(const i of t.manifest.getForScope(e).values()){const e=n.tryWorkspaceByDescriptor(i);null!==e&&await a.addBuildTarget(e)}await a.addBuildTarget(t)}await a.addBuildTarget(s)}else await a.addBuildTarget(s);!1===await a.run()&&i.reportError(r.MessageName.BUILD_FAILED,"Build failed")})).exitCode()}}N.usage=a.Command.Usage({category:"Build commands",description:"build a package and all its dependencies",details:'\n      In a monorepo with internal packages that depend on others, this command\n      will traverse the dependency graph and efficiently ensure, the packages\n      are built in the right order.\n\n      - If `-p,--parallel` and `-i,--interlaced` are both set, Yarn\n      will print the lines from the output as it receives them.\n      Parallel defaults to true.\n\n      If `-i,--interlaced` wasn\'t set, it would instead buffer the output\n      from each process and print the resulting buffers only after their\n      source processes have exited. Defaults to false.\n\n      If the `--json` flag is set the output will follow a JSON-stream output\n      also known as NDJSON (https://github.com/ndjson/ndjson-spec).\n\n      `-c,--build-command` is the command to be run in each package (if available), defaults to "build"\n    '}),j([a.Command.Boolean("--json")],N.prototype,"json",void 0),j([a.Command.String("-c,--build-command")],N.prototype,"buildCommand",void 0),j([a.Command.Boolean("-p,--parallel")],N.prototype,"parallel",void 0),j([a.Command.Boolean("-i,--interlaced")],N.prototype,"interlaced",void 0),j([a.Command.Boolean("-v,--verbose")],N.prototype,"verbose",void 0),j([a.Command.Boolean("-d,--dry-run")],N.prototype,"dryRun",void 0),j([a.Command.Path("build")],N.prototype,"execute",null);const D=(e,t)=>{const i=[];for(const n of e.workspacesCwds){const e=t.workspacesByCwd.get(n);e&&i.push(e,...D(e,t))}return i},A={commands:[c,N]}},461:e=>{e.exports=({onlyFirst:e=!1}={})=>{const t=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|");return new RegExp(t,e?void 0:"g")}},344:(e,t)=>{class i{constructor(e){this.tasks=[],this.count=e}sched(){if(this.count>0&&this.tasks.length>0){this.count--;let e=this.tasks.shift();if(void 0===e)throw"Unexpected undefined value in tasks list";e()}}acquire(){return new Promise((e,t)=>{this.tasks.push(()=>{var t=!1;e(()=>{t||(t=!0,this.count++,this.sched())})}),process&&process.nextTick?process.nextTick(this.sched.bind(this)):setImmediate(this.sched.bind(this))})}use(e){return this.acquire().then(t=>e().then(e=>(t(),e)).catch(e=>{throw t(),e}))}}t.W=class extends i{constructor(){super(1)}}},187:(e,t,i)=>{var n=i(526),r=process.env;function o(e){return"string"==typeof e?!!r[e]:Object.keys(e).every((function(t){return r[t]===e[t]}))}Object.defineProperty(t,"_vendors",{value:n.map((function(e){return e.constant}))}),t.name=null,t.isPR=null,n.forEach((function(e){var i=(Array.isArray(e.env)?e.env:[e.env]).every((function(e){return o(e)}));if(t[e.constant]=i,i)switch(t.name=e.name,typeof e.pr){case"string":t.isPR=!!r[e.pr];break;case"object":"env"in e.pr?t.isPR=e.pr.env in r&&r[e.pr.env]!==e.pr.ne:"any"in e.pr?t.isPR=e.pr.any.some((function(e){return!!r[e]})):t.isPR=o(e.pr);break;default:t.isPR=null}})),t.isCI=!!(r.CI||r.CONTINUOUS_INTEGRATION||r.BUILD_NUMBER||r.RUN_ID||t.name)},526:e=>{e.exports=JSON.parse('[{"name":"AppVeyor","constant":"APPVEYOR","env":"APPVEYOR","pr":"APPVEYOR_PULL_REQUEST_NUMBER"},{"name":"Azure Pipelines","constant":"AZURE_PIPELINES","env":"SYSTEM_TEAMFOUNDATIONCOLLECTIONURI","pr":"SYSTEM_PULLREQUEST_PULLREQUESTID"},{"name":"Bamboo","constant":"BAMBOO","env":"bamboo_planKey"},{"name":"Bitbucket Pipelines","constant":"BITBUCKET","env":"BITBUCKET_COMMIT","pr":"BITBUCKET_PR_ID"},{"name":"Bitrise","constant":"BITRISE","env":"BITRISE_IO","pr":"BITRISE_PULL_REQUEST"},{"name":"Buddy","constant":"BUDDY","env":"BUDDY_WORKSPACE_ID","pr":"BUDDY_EXECUTION_PULL_REQUEST_ID"},{"name":"Buildkite","constant":"BUILDKITE","env":"BUILDKITE","pr":{"env":"BUILDKITE_PULL_REQUEST","ne":"false"}},{"name":"CircleCI","constant":"CIRCLE","env":"CIRCLECI","pr":"CIRCLE_PULL_REQUEST"},{"name":"Cirrus CI","constant":"CIRRUS","env":"CIRRUS_CI","pr":"CIRRUS_PR"},{"name":"AWS CodeBuild","constant":"CODEBUILD","env":"CODEBUILD_BUILD_ARN"},{"name":"Codeship","constant":"CODESHIP","env":{"CI_NAME":"codeship"}},{"name":"Drone","constant":"DRONE","env":"DRONE","pr":{"DRONE_BUILD_EVENT":"pull_request"}},{"name":"dsari","constant":"DSARI","env":"DSARI"},{"name":"GitLab CI","constant":"GITLAB","env":"GITLAB_CI"},{"name":"GoCD","constant":"GOCD","env":"GO_PIPELINE_LABEL"},{"name":"Hudson","constant":"HUDSON","env":"HUDSON_URL"},{"name":"Jenkins","constant":"JENKINS","env":["JENKINS_URL","BUILD_ID"],"pr":{"any":["ghprbPullId","CHANGE_ID"]}},{"name":"Magnum CI","constant":"MAGNUM","env":"MAGNUM"},{"name":"Netlify CI","constant":"NETLIFY","env":"NETLIFY_BUILD_BASE","pr":{"env":"PULL_REQUEST","ne":"false"}},{"name":"Sail CI","constant":"SAIL","env":"SAILCI","pr":"SAIL_PULL_REQUEST_NUMBER"},{"name":"Semaphore","constant":"SEMAPHORE","env":"SEMAPHORE","pr":"PULL_REQUEST_NUMBER"},{"name":"Shippable","constant":"SHIPPABLE","env":"SHIPPABLE","pr":{"IS_PULL_REQUEST":"true"}},{"name":"Solano CI","constant":"SOLANO","env":"TDDIUM","pr":"TDDIUM_PR_ID"},{"name":"Strider CD","constant":"STRIDER","env":"STRIDER"},{"name":"TaskCluster","constant":"TASKCLUSTER","env":["TASK_ID","RUN_ID"]},{"name":"TeamCity","constant":"TEAMCITY","env":"TEAMCITY_VERSION"},{"name":"Travis CI","constant":"TRAVIS","env":"TRAVIS","pr":{"env":"TRAVIS_PULL_REQUEST","ne":"false"}}]')},178:e=>{var t=Object.prototype.hasOwnProperty,i="~";function n(){}function r(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function o(e,t,n,o,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new r(n,o||e,s),u=i?i+t:t;return e._events[u]?e._events[u].fn?e._events[u]=[e._events[u],a]:e._events[u].push(a):(e._events[u]=a,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,n,r=[];if(0===this._eventsCount)return r;for(n in e=this._events)t.call(e,n)&&r.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},a.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,o=n.length,s=new Array(o);r<o;r++)s[r]=n[r].fn;return s},a.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,r,o,s){var a=i?i+e:e;if(!this._events[a])return!1;var u,l,d=this._events[a],c=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),c){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,n),!0;case 4:return d.fn.call(d.context,t,n,r),!0;case 5:return d.fn.call(d.context,t,n,r,o),!0;case 6:return d.fn.call(d.context,t,n,r,o,s),!0}for(l=1,u=new Array(c-1);l<c;l++)u[l-1]=arguments[l];d.fn.apply(d.context,u)}else{var h,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),c){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,n);break;case 4:d[l].fn.call(d[l].context,t,n,r);break;default:if(!u)for(h=1,u=new Array(c-1);h<c;h++)u[h-1]=arguments[h];d[l].fn.apply(d[l].context,u)}}return!0},a.prototype.on=function(e,t,i){return o(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return o(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,n,r){var o=i?i+e:e;if(!this._events[o])return this;if(!t)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||r&&!a.once||n&&a.context!==n||s(this,o);else{for(var u=0,l=[],d=a.length;u<d;u++)(a[u].fn!==t||r&&!a[u].once||n&&a[u].context!==n)&&l.push(a[u]);l.length?this._events[o]=1===l.length?l[0]:l:s(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&s(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a},820:(e,t,i)=>{e.exports=i(187).isCI},473:e=>{e.exports=(e,t)=>(t=t||(()=>{}),e.then(e=>new Promise(e=>{e(t())}).then(()=>e),e=>new Promise(e=>{e(t())}).then(()=>{throw e})))},299:(e,t,i)=>{const n=i(679),r=e=>{if(!Number.isInteger(e)&&e!==1/0||!(e>0))return Promise.reject(new TypeError("Expected `concurrency` to be a number from 1 and up"));const t=[];let i=0;const r=()=>{i--,t.length>0&&t.shift()()},o=(e,t,...o)=>{i++;const s=n(e,...o);t(s),s.then(r,r)},s=(n,...r)=>new Promise(s=>((n,r,...s)=>{i<e?o(n,r,...s):t.push(o.bind(null,n,r,...s))})(n,s,...r));return Object.defineProperties(s,{activeCount:{get:()=>i},pendingCount:{get:()=>t.length},clearQueue:{value:()=>{t.length=0}}}),s};e.exports=r,e.exports.default=r},103:(e,t,i)=>{const n=i(178),r=i(688),o=i(443),s=()=>{},a=new r.TimeoutError;t.Z=class extends n{constructor(e){if(super(),Object.defineProperty(this,"_carryoverConcurrencyCount",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_isIntervalIgnored",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_intervalCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_intervalCap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_interval",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_intervalEnd",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_intervalId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_timeoutId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_queueClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_pendingCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_concurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_isPaused",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_resolveEmpty",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_resolveIdle",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_throwOnTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:o.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother()}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s)}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother)return this.emit("active"),this._queue.dequeue()(),e&&this._initializeIntervalIfNeeded(),!0}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((i,n)=>{this._queue.enqueue(async()=>{this._pendingCount++,this._intervalCount++;try{const o=void 0===this._timeout&&void 0===t.timeout?e():r.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&n(a)});i(await o)}catch(e){n(e)}this._next()},t),this._tryToStartAnother()})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}set timeout(e){this._timeout=e}get timeout(){return this._timeout}}},310:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,i){let n=0,r=e.length;for(;r>0;){const o=r/2|0;let s=n+o;i(e[s],t)<=0?(n=++s,r-=o+1):r=o}return n}},443:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=i(310);t.default=class{constructor(){Object.defineProperty(this,"_queue",{enumerable:!0,configurable:!0,writable:!0,value:[]})}enqueue(e,t){const i={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(i);const r=n.default(this._queue,i,(e,t)=>t.priority-e.priority);this._queue.splice(r,0,i)}dequeue(){const e=this._queue.shift();return e&&e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this._queue.length}}},688:(e,t,i)=>{const n=i(473);class r extends Error{constructor(e){super(e),this.name="TimeoutError"}}const o=(e,t,i)=>new Promise((o,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void o(e);const a=setTimeout(()=>{if("function"==typeof i){try{o(i())}catch(e){s(e)}return}const n=i instanceof Error?i:new r("string"==typeof i?i:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(n)},t);n(e.then(o,s),()=>{clearTimeout(a)})});e.exports=o,e.exports.default=o,e.exports.TimeoutError=r},679:e=>{const t=(e,...t)=>new Promise(i=>{i(e(...t))});e.exports=t,e.exports.default=t},106:(e,t,i)=>{const n=i(461);e.exports=e=>"string"==typeof e?e.replace(n(),""):e}},t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={exports:{}};return e[n](r,r.exports,i),r.exports}return i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(446)})();
return plugin;
}
};